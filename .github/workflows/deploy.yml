name: Deploy to Vercel & Render

# ─────────────────────────────────────────────────────────────────
# This workflow deploys ONLY after the "Test & Code Quality"
# workflow succeeds on main.
#
# Auto-deploy on Vercel and Render is DISABLED via:
#   • frontend/vercel.json  →  "git": { "deploymentEnabled": false }
#   • render.yaml           →  autoDeploy: false
#
# Deployments are triggered exclusively by this workflow using
# the Vercel CLI and Render deploy hooks.
# ─────────────────────────────────────────────────────────────────

on:
  workflow_run:
    workflows: [Test & Code Quality]
    types: [completed]
    branches: [main]

permissions:
  contents: read

jobs:
  # ─────────────────────────────────────────────
  # Check if quality gates passed before deploying
  # ─────────────────────────────────────────────
  check-quality-gate:
    name: Quality Gate Check
    runs-on: ubuntu-latest
    outputs:
      approved: ${{ steps.gate.outputs.approved }}
    steps:
      - name: Check workflow status
        id: gate
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "approved=false" >> $GITHUB_OUTPUT
            echo "❌ Quality checks failed — blocking deployment"
          else
            echo "approved=true" >> $GITHUB_OUTPUT
            echo "✅ Quality gates passed — proceeding with deployment"
          fi

  # ─────────────────────────────────────────────
  # Deploy frontend to Vercel (via CLI)
  # ─────────────────────────────────────────────
  deploy-vercel:
    name: Deploy Frontend to Vercel
    runs-on: ubuntu-latest
    needs: check-quality-gate
    if: needs.check-quality-gate.outputs.approved == 'true'
    environment:
      name: production-frontend
      url: https://gpu-connect.vercel.app
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel environment information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build project artifacts
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel (production)
        run: |
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "✅ Frontend deployed to Vercel"
          echo "URL: $DEPLOYMENT_URL"

  # ─────────────────────────────────────────────
  # Deploy backend to Render (via deploy hook)
  # ─────────────────────────────────────────────
  deploy-render:
    name: Deploy Backend to Render
    runs-on: ubuntu-latest
    needs: check-quality-gate
    if: needs.check-quality-gate.outputs.approved == 'true'
    environment:
      name: production-backend
      url: https://gpu-connect-api.onrender.com
    steps:
      - name: Trigger Render deploy hook
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.RENDER_DEPLOY_WEBHOOK }}")
          if [ "$RESPONSE" -ge 200 ] && [ "$RESPONSE" -lt 300 ]; then
            echo "✅ Backend deployment triggered on Render (HTTP $RESPONSE)"
          else
            echo "⚠️  Render deploy hook returned HTTP $RESPONSE"
            exit 1
          fi

  # ─────────────────────────────────────────────
  # Notify on failed quality gate
  # ─────────────────────────────────────────────
  notify-blocked:
    name: Deployment Blocked
    runs-on: ubuntu-latest
    needs: check-quality-gate
    if: needs.check-quality-gate.outputs.approved != 'true'
    steps:
      - name: Log blocked deployment
        run: |
          echo "❌ Deployment blocked — quality checks did not pass"
          echo "Fix failing tests / code quality issues and push again"
